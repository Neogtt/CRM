# crm_summary.py
import streamlit as st
import pandas as pd
import numpy as np
import datetime
from google.oauth2 import service_account
from googleapiclient.discovery import build

# ======================
# GENEL AYARLAR
# ======================
st.set_page_config(page_title="CRM √ñzet Ekran", layout="wide")
SHEET_ID = "1A_gL11UL6JFAoZrMrg92K8bAegeCn_KzwUyU8AWzE_0"
SHEET_NAME = "Proformalar"

# ======================
# GOOGLE SHEETS SERVƒ∞S
# ======================
@st.cache_resource
def build_sheets():
    creds = service_account.Credentials.from_service_account_info(
        st.secrets["gcp_service_account"],
        scopes=["https://www.googleapis.com/auth/spreadsheets.readonly"]
    )
    return build("sheets", "v4", credentials=creds, cache_discovery=False)

sheets_svc = build_sheets()

def load_sheet(sheet_id: str, sheet_name: str) -> pd.DataFrame:
    try:
        result = sheets_svc.spreadsheets().values().get(
            spreadsheetId=sheet_id,
            range=f"{sheet_name}!A:ZZ"
        ).execute()
        values = result.get("values", [])
        if not values:
            return pd.DataFrame()
        header, rows = values[0], values[1:]
        df = pd.DataFrame(rows, columns=header)
        return df
    except Exception as e:
        st.error(f"Google Sheets okuma hatasƒ±: {e}")
        return pd.DataFrame()

# ======================
# VERƒ∞ Y√úKLEME
# ======================
df_proforma = load_sheet(SHEET_ID, SHEET_NAME)

if df_proforma.empty:
    st.warning("Google Sheets 'Proformalar' tablosu bo≈ü veya eri≈üilemedi.")
    st.stop()

# Tutarlarƒ± numeric yap
if "Tutar" in df_proforma.columns:
    df_proforma["Tutar"] = pd.to_numeric(df_proforma["Tutar"], errors="coerce")
else:
    df_proforma["Tutar"] = 0.0

# Tarih s√ºtununu datetime √ßevir
if "Tarih" in df_proforma.columns:
    df_proforma["Tarih"] = pd.to_datetime(df_proforma["Tarih"], errors="coerce")

# ======================
# √ñZET EKRAN
# ======================
st.markdown("# üìä CRM √ñzet Ekran")

# === Bekleyen Proformalar ===
st.markdown("## üìù Bekleyen Proformalar")
if "Durum" in df_proforma.columns:
    bekleyen = df_proforma[df_proforma["Durum"] == "Beklemede"].copy()
    toplam_bekleyen = pd.to_numeric(bekleyen["Tutar"], errors="coerce").sum()
    st.markdown(f"**Toplam Bekleyen:** {toplam_bekleyen:,.2f} $")
    if not bekleyen.empty:
        bekleyen["Tarih"] = bekleyen["Tarih"].dt.strftime("%d/%m/%Y")
        st.dataframe(
            bekleyen[["M√º≈üteri Adƒ±", "Proforma No", "Tarih", "Tutar", "Vade (g√ºn)", "A√ßƒ±klama"]],
            use_container_width=True
        )
    else:
        st.info("Bekleyen proforma yok.")
else:
    st.warning("'Durum' s√ºtunu bulunamadƒ±.")

# === Vade Takibi ===
st.markdown("## üí∞ Vade Takibi")
if "Vade (g√ºn)" in df_proforma.columns and "Tarih" in df_proforma.columns:
    df_vade = df_proforma.copy()
    df_vade["Vade Tarihi"] = df_vade["Tarih"] + pd.to_timedelta(
        pd.to_numeric(df_vade["Vade (g√ºn)"], errors="coerce").fillna(0), unit="D"
    )
    bugun = datetime.date.today()
    df_vade["Durum_Vade"] = np.where(
        (df_vade["Vade Tarihi"].notna()) & (df_vade["Vade Tarihi"].dt.date < bugun),
        "‚ùå Gecikmi≈ü",
        "‚úÖ Beklemede"
    )
    toplam_bekleyen = pd.to_numeric(df_vade[df_vade["Durum_Vade"]=="‚úÖ Beklemede"]["Tutar"], errors="coerce").sum()
    toplam_gecikmis = pd.to_numeric(df_vade[df_vade["Durum_Vade"]=="‚ùå Gecikmi≈ü"]["Tutar"], errors="coerce").sum()
    st.markdown(f"- ‚úÖ Beklemede: {toplam_bekleyen:,.2f} $")
    st.markdown(f"- ‚ùå Gecikmi≈ü: {toplam_gecikmis:,.2f} $")
    st.dataframe(
        df_vade[["M√º≈üteri Adƒ±","Proforma No","Tarih","Vade Tarihi","Tutar","Durum_Vade"]],
        use_container_width=True
    )
else:
    st.warning("'Vade (g√ºn)' veya 'Tarih' s√ºtunu bulunamadƒ±.")

# === ETA Takibi ===
st.markdown("## üõ≥Ô∏è ETA Takibi")
if "Sevk Durumu" in df_proforma.columns:
    eta_yolda = df_proforma[df_proforma["Sevk Durumu"] == "Sevkedildi"].copy()
    toplam_eta = pd.to_numeric(eta_yolda["Tutar"], errors="coerce").sum()
    st.markdown(f"**Toplam Yolda:** {toplam_eta:,.2f} $")
    if not eta_yolda.empty:
        eta_yolda["Tarih"] = eta_yolda["Tarih"].dt.strftime("%d/%m/%Y")
        st.dataframe(
            eta_yolda[["M√º≈üteri Adƒ±","√úlke","Proforma No","Tarih","Tutar","Vade (g√ºn)","A√ßƒ±klama"]],
            use_container_width=True
        )
    else:
        st.info("Yolda olan sipari≈ü yok.")
else:
    st.warning("'Sevk Durumu' s√ºtunu bulunamadƒ±.")

# === Son Teslim Edilenler ===
st.markdown("## ‚úÖ Son Teslim Edilenler")
if "Sevk Durumu" in df_proforma.columns:
    teslim = df_proforma[df_proforma["Sevk Durumu"] == "Ula≈üƒ±ldƒ±"].copy()
    if not teslim.empty:
        teslim = teslim.sort_values(by="Tarih", ascending=False).head(5)
        teslim["Tarih"] = teslim["Tarih"].dt.strftime("%d/%m/%Y")
        st.dataframe(
            teslim[["M√º≈üteri Adƒ±","√úlke","Proforma No","Tarih","Tutar","Vade (g√ºn)","A√ßƒ±klama"]],
            use_container_width=True
        )
    else:
        st.info("Teslim edilmi≈ü sipari≈ü yok.")
else:
    st.warning("'Sevk Durumu' s√ºtunu bulunamadƒ±.")
